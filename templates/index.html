<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Chat CLI</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background-color: #f4f4f9; }
        header { background-color: #fff; padding: 20px; border-bottom: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h1, h2 { margin: 0; color: #333; }
        h1 { font-size: 1.5em; }
        h2 { font-size: 1.1em; margin-top: 15px; }
        main { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 250px; background-color: #fdfdfd; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; }
        .chat-container { flex: 1; display: flex; flex-direction: column; }
        #project-list button { display: block; width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid #ccc; background-color: #f9f9f9; text-align: left; cursor: pointer; border-radius: 5px; font-size: 1em; }
        #project-list button:hover { background-color: #e9e9e9; }
        #project-list button.selected { background-color: #007bff; color: white; border-color: #007bff; font-weight: bold; }
        #current-selection { margin-top: 20px; padding: 10px; background-color: #e9f5ff; border-radius: 5px; color: #333; }
        .cli-selector { margin-top: 15px; }
        .cli-selector label { margin-right: 15px; cursor: pointer; }
        #chat-log { flex: 1; padding: 20px; overflow-y: auto; background-color: #fff; }
        .message { margin-bottom: 15px; padding: 12px 18px; border-radius: 18px; max-width: 80%; line-height: 1.5; }
        .user-message { background-color: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .assistant-message { background-color: #e9ecef; color: #333; align-self: flex-start; white-space: pre-wrap; }
        .error-message { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #ddd; background: #fff; }
        .chat-actions { display: flex; gap: 10px; }
        .chat-action-button { padding: 8px 16px; border: 1px solid #ccc; background-color: #f8f9fa; color: #333; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
        .chat-action-button:hover { background-color: #e9ecef; }
        .chat-action-button.primary { background-color: #28a745; color: white; border-color: #28a745; }
        .chat-action-button.primary:hover { background-color: #218838; }
        #chat-form { display: flex; padding: 20px; border-top: 1px solid #ddd; background: #fff; }
        #message-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; }
        #send-button { padding: 10px 20px; margin-left: 10px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; font-size: 1em; }
        #send-button:disabled { background-color: #a0a0a0; }
        .history-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; }
        .history-modal.active { display: flex; justify-content: center; align-items: center; }
        .history-content { background: white; padding: 30px; border-radius: 10px; max-width: 800px; max-height: 80vh; width: 90%; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .history-close { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .history-item { padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .history-item:hover { background-color: #f8f9fa; }
        .history-item.selected { background-color: #e7f3ff; border-color: #007bff; }
        .history-item-header { font-weight: bold; color: #333; margin-bottom: 8px; }
        .history-item-preview { color: #666; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item-time { color: #999; font-size: 0.8em; margin-top: 5px; }
        .empty-history { text-align: center; color: #999; padding: 40px; }
    </style>
</head>
<body>
    <header>
        <h1>Remote Chat CLI</h1>
        <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;">
            <button id="restart-server-button" style="padding: 8px 16px; background-color: #ffc107; color: #333; border: none; border-radius: 5px; cursor: pointer; display: none;">ì„œë²„ ì¬ì‹œì‘</button>
            <button id="logout-button" style="padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </header>
    <main>
        <aside class="sidebar">
            <h2>Projects</h2>
            <div id="project-list">
                <button id="deselect-project-button" style="display: block; width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid #28a745; background-color: #f8f9fa; text-align: left; cursor: pointer; border-radius: 5px; font-size: 0.9em; color: #28a745;">
                    ğŸ“ BASE_DIRì—ì„œ ì‹¤í–‰
                </button>
            </div>
            <div id="current-selection">
                Selected Project: <strong id="selected-project-name">None (BASE_DIRì—ì„œ ì‹¤í–‰)</strong>
            </div>
            <div id="project-server-controls" style="margin-top: 15px; display: none;">
                <button id="restart-project-server-button" class="chat-action-button" style="width: 100%; margin-top: 10px; padding: 8px; font-size: 0.9em;">í”„ë¡œì íŠ¸ ì„œë²„ ì¬ì‹œì‘</button>
                <div id="project-server-status" style="margin-top: 10px; padding: 8px; background-color: #f8f9fa; border-radius: 5px; font-size: 0.85em; color: #666;"></div>
            </div>
            <div class="cli-selector">
                <h2>CLI Tool</h2>
                <label><input type="radio" name="cli" value="gemini" checked> Gemini</label>
                <label><input type="radio" name="cli" value="claude"> Claude</label>
                <label><input type="radio" name="cli" value="echo"> Echo (for Testing)</label>
            </div>
        </aside>
        <div class="chat-container">
            <div class="chat-header">
                <h2 style="margin: 0;">ì±„íŒ…</h2>
                <div class="chat-actions">
                    <button id="new-chat-button" class="chat-action-button primary">ìƒˆë¡œ ì±„íŒ…í•˜ê¸°</button>
                    <button id="history-button" class="chat-action-button">íˆìŠ¤í† ë¦¬</button>
                </div>
            </div>
            <div id="chat-log"></div>
            <form id="chat-form">
                <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
                <button type="submit" id="send-button">ì „ì†¡</button>
            </form>
        </div>
        
        <!-- íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ -->
        <div id="history-modal" class="history-modal">
            <div class="history-content">
                <div class="history-header">
                    <h2 style="margin: 0;">ëŒ€í™” íˆìŠ¤í† ë¦¬</h2>
                    <button id="history-close" class="history-close">ë‹«ê¸°</button>
                </div>
                <div id="history-list"></div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const projectList = document.getElementById('project-list');
            const selectedProjectName = document.getElementById('selected-project-name');
            const chatLog = document.getElementById('chat-log');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');

            let selectedProjectId = null;
            let currentSessionId = null; // í˜„ì¬ ì±„íŒ… ì„¸ì…˜ ID
            let isNewChat = true; // ìƒˆ ì±„íŒ…ì¸ì§€ ì—¬ë¶€

            // --- Core Functions ---

            const fetchProjects = async () => {
                try {
                    const response = await fetch('/api/projects');
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/login';
                        return;
                    }
                    if (!response.ok) throw new Error('Failed to fetch projects');
                    const projects = await response.json();
                    
                    // BASE_DIR ì„ íƒ ë²„íŠ¼ì€ ìœ ì§€í•˜ê³  í”„ë¡œì íŠ¸ ëª©ë¡ë§Œ ì—…ë°ì´íŠ¸
                    const deselectButton = document.getElementById('deselect-project-button');
                    projectList.innerHTML = '';
                    projectList.appendChild(deselectButton);
                    
                    projects.forEach(project => {
                        const button = document.createElement('button');
                        button.textContent = project.name;
                        if (project.has_server) {
                            button.textContent += ' ğŸ–¥ï¸';
                        }
                        button.dataset.projectId = project.id;
                        button.dataset.hasServer = project.has_server || false;
                        button.dataset.port = project.port || '';
                        button.addEventListener('click', () => selectProject(project.id));
                        projectList.appendChild(button);
                    });
                } catch (error) {
                    console.error(error);
                    appendMessage('Failed to load projects. Please ensure the server is running and the base directory is correct.', 'error');
                }
            };

            const deselectProject = async () => {
                try {
                    const response = await fetch('/api/select-project', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ projectId: null })
                    });
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/login';
                        return;
                    }
                    if (!response.ok) throw new Error('Failed to deselect project');

                    selectedProjectId = null;
                    selectedProjectName.textContent = 'None (BASE_DIRì—ì„œ ì‹¤í–‰)';

                    // Update button styles
                    document.querySelectorAll('#project-list button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    document.getElementById('deselect-project-button').classList.add('selected');
                    
                    // í”„ë¡œì íŠ¸ ì„œë²„ ì»¨íŠ¸ë¡¤ ìˆ¨ê¸°ê¸°
                    document.getElementById('project-server-controls').style.display = 'none';
                    
                    // BASE_DIR íˆìŠ¤í† ë¦¬ ë¡œë“œ
                    await fetchHistory(null);
                } catch (error) {
                    console.error(error);
                    appendMessage(`í”„ë¡œì íŠ¸ ì„ íƒ í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, 'error');
                }
            };

            const selectProject = async (projectId) => {
                try {
                    const response = await fetch('/api/select-project', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ projectId })
                    });
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/login';
                        return;
                    }
                    if (!response.ok) throw new Error('Failed to select project');

                    selectedProjectId = projectId;
                    selectedProjectName.textContent = projectId;

                    // Update button styles
                    document.querySelectorAll('#project-list button').forEach(btn => {
                        btn.classList.toggle('selected', btn.dataset.projectId === projectId);
                    });
                    document.getElementById('deselect-project-button').classList.remove('selected');
                    
                    // í”„ë¡œì íŠ¸ ì„œë²„ ìƒíƒœ í™•ì¸ ë° ì»¨íŠ¸ë¡¤ í‘œì‹œ
                    await checkProjectServerStatus(projectId);
                    
                    await fetchHistory(projectId);
                } catch (error) {
                    console.error(error);
                    appendMessage(`Error selecting project ${projectId}.`, 'error');
                }
            };

            // --- Project Server Functions ---
            const checkProjectServerStatus = async (projectId) => {
                const controls = document.getElementById('project-server-controls');
                const statusDiv = document.getElementById('project-server-status');
                const restartButton = document.getElementById('restart-project-server-button');
                
                try {
                    const response = await fetch(`/api/projects/${projectId}/server/status`);
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.has_server) {
                            controls.style.display = 'block';
                            
                            let statusText = 'ì„œë²„ ìƒíƒœ: ';
                            if (data.port) {
                                statusText += `í¬íŠ¸ ${data.port} - `;
                                statusText += data.port_in_use ? 'ì‹¤í–‰ ì¤‘ âœ…' : 'ì¤‘ì§€ë¨ âŒ';
                            } else {
                                statusText += 'í¬íŠ¸ ì •ë³´ ì—†ìŒ';
                            }
                            
                            statusDiv.textContent = statusText;
                            
                            // ê´€ë¦¬ìë§Œ ì¬ì‹œì‘ ë²„íŠ¼ í‘œì‹œ
                            if (data.is_admin) {
                                restartButton.style.display = 'block';
                            } else {
                                restartButton.style.display = 'none';
                            }
                        } else {
                            controls.style.display = 'none';
                        }
                    } else {
                        controls.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Project server status check error:', error);
                    controls.style.display = 'none';
                }
            };

            const handleRestartProjectServer = async () => {
                if (!selectedProjectId) {
                    alert('ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                if (!confirm(`í”„ë¡œì íŠ¸ '${selectedProjectId}'ì˜ ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
                
                const restartButton = document.getElementById('restart-project-server-button');
                restartButton.disabled = true;
                restartButton.textContent = 'ì¬ì‹œì‘ ì¤‘...';
                
                try {
                    const response = await fetch(`/api/projects/${selectedProjectId}/server/restart`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        alert(data.message + '\n' + (data.warning || ''));
                        // ëª‡ ì´ˆ í›„ ìƒíƒœ ì¬í™•ì¸
                        setTimeout(() => {
                            checkProjectServerStatus(selectedProjectId);
                        }, 3000);
                    } else {
                        alert('ì„œë²„ ì¬ì‹œì‘ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (error) {
                    console.error('Restart error:', error);
                    alert('ì„œë²„ ì¬ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } finally {
                    restartButton.disabled = false;
                    restartButton.textContent = 'í”„ë¡œì íŠ¸ ì„œë²„ ì¬ì‹œì‘';
                }
            };

            const fetchHistory = async (projectId, sessionId = null) => {
                chatLog.innerHTML = ''; // Clear previous history
                try {
                    let url = `/api/history?projectId=${projectId}`;
                    if (sessionId) {
                        url += `&sessionId=${sessionId}`;
                    }
                    const response = await fetch(url);
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/login';
                        return;
                    }
                    if (!response.ok) throw new Error('Failed to fetch history');
                    const history = await response.json();
                    
                    if (history.length > 0) {
                        history.forEach(item => {
                            appendMessage(item.user_message, 'user');
                            appendMessage(item.assistant_message, 'assistant');
                        });
                    } else if (!sessionId) {
                        // íˆìŠ¤í† ë¦¬ê°€ ì—†ê³  ìƒˆ ì±„íŒ…ì´ ì•„ë‹ ë•Œë§Œ ë©”ì‹œì§€ í‘œì‹œ
                        appendMessage('ì´ì „ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.', 'assistant');
                    }
                } catch (error) {
                    console.error(error);
                    appendMessage(`íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`, 'error');
                }
            };

            const handleFormSubmit = async (event) => {
                event.preventDefault();
                const message = messageInput.value.trim();
                const selectedCli = document.querySelector('input[name="cli"]:checked')?.value;

                if (!selectedCli) {
                    alert('CLI ë„êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (!message) return;

                appendMessage(message, 'user');
                messageInput.value = '';
                sendButton.disabled = true;

                try {
                    const requestBody = {
                        cli: selectedCli,
                        message: message
                    };
                    
                    // í”„ë¡œì íŠ¸ê°€ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ì¶”ê°€ (ì—†ìœ¼ë©´ BASE_DIRì—ì„œ ì‹¤í–‰)
                    if (selectedProjectId) {
                        requestBody.projectId = selectedProjectId;
                    }
                    
                    // ìƒˆ ì±„íŒ…ì´ë©´ sessionIdë¥¼ nullë¡œ, ì•„ë‹ˆë©´ í˜„ì¬ sessionId ì‚¬ìš©
                    if (isNewChat) {
                        requestBody.newSession = true;
                        isNewChat = false;
                    } else if (currentSessionId) {
                        requestBody.sessionId = currentSessionId;
                    }

                    const response = await fetch('/api/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/login';
                        return;
                    }

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                    
                    appendMessage(data.assistant_message, 'assistant');
                    
                    // ì„¸ì…˜ ID ì—…ë°ì´íŠ¸
                    if (data.sessionId) {
                        currentSessionId = data.sessionId;
                    }

                } catch (error) {
                    console.error(error);
                    appendMessage(`ì˜¤ë¥˜: ${error.message}`, 'error');
                } finally {
                    sendButton.disabled = false;
                    messageInput.focus();
                }
            };

            // --- Helper Functions ---

            const appendMessage = (text, type) => {
                const messageDiv = document.createElement('div');
                messageDiv.textContent = text;
                if (type === 'user') {
                    messageDiv.className = 'message user-message';
                } else if (type === 'assistant') {
                    messageDiv.className = 'message assistant-message';
                } else { // 'error'
                    messageDiv.className = 'message error-message';
                }
                chatLog.appendChild(messageDiv);
                chatLog.scrollTop = chatLog.scrollHeight;
            };

            // --- New Chat Function ---
            const startNewChat = () => {
                if (confirm('ìƒˆë¡œìš´ ì±„íŒ…ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ëŒ€í™” ë‚´ìš©ì€ ì €ì¥ë©ë‹ˆë‹¤.')) {
                    chatLog.innerHTML = '';
                    currentSessionId = null;
                    isNewChat = true;
                    appendMessage('ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?', 'assistant');
                }
            };

            // --- History Functions ---
            const showHistory = async () => {
                // í”„ë¡œì íŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ "__root__" ì‚¬ìš© (BASE_DIR)
                const projectIdForHistory = selectedProjectId || "__root__";
                
                const modal = document.getElementById('history-modal');
                const historyList = document.getElementById('history-list');
                
                modal.classList.add('active');
                historyList.innerHTML = '<div style="text-align: center; padding: 20px;">ë¡œë”© ì¤‘...</div>';
                
                try {
                    const response = await fetch(`/api/history/sessions?projectId=${projectIdForHistory}`);
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/login';
                        return;
                    }
                    if (!response.ok) throw new Error('íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    
                    const sessions = await response.json();
                    
                    if (sessions.length === 0) {
                        historyList.innerHTML = '<div class="empty-history">ì €ì¥ëœ ëŒ€í™” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }
                    
                    historyList.innerHTML = '';
                    sessions.forEach(session => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        item.dataset.sessionId = session.sessionId;
                        
                        const preview = session.firstMessage || 'ëŒ€í™” ë‚´ìš© ì—†ìŒ';
                        const time = new Date(session.timestamp).toLocaleString('ko-KR');
                        
                        item.innerHTML = `
                            <div class="history-item-header">ì„¸ì…˜ ${session.sessionId}</div>
                            <div class="history-item-preview">${preview}</div>
                            <div class="history-item-time">${time}</div>
                        `;
                        
                        item.addEventListener('click', () => {
                            loadHistorySession(session.sessionId);
                        });
                        
                        historyList.appendChild(item);
                    });
                } catch (error) {
                    console.error(error);
                    historyList.innerHTML = `<div class="empty-history">ì˜¤ë¥˜: ${error.message}</div>`;
                }
            };

            const loadHistorySession = async (sessionId) => {
                // í”„ë¡œì íŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ "__root__" ì‚¬ìš©
                const projectIdForHistory = selectedProjectId || "__root__";
                
                currentSessionId = sessionId;
                isNewChat = false;
                
                await fetchHistory(projectIdForHistory, sessionId);
                
                // ëª¨ë‹¬ ë‹«ê¸°
                document.getElementById('history-modal').classList.remove('active');
            };

            const closeHistoryModal = () => {
                document.getElementById('history-modal').classList.remove('active');
            };

            // --- Server Restart Function ---
            const handleRestartServer = async () => {
                if (!confirm('ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì¬ì‹œì‘ ì¤‘ì—ëŠ” ì¼ì‹œì ìœ¼ë¡œ ì ‘ì†ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.')) {
                    return;
                }
                
                const restartButton = document.getElementById('restart-server-button');
                restartButton.disabled = true;
                restartButton.textContent = 'ì¬ì‹œì‘ ì¤‘...';
                
                try {
                    const response = await fetch('/api/server/restart', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        alert(data.message + '\n' + (data.warning || ''));
                        // ëª‡ ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    } else {
                        alert('ì„œë²„ ì¬ì‹œì‘ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                        restartButton.disabled = false;
                        restartButton.textContent = 'ì„œë²„ ì¬ì‹œì‘';
                    }
                } catch (error) {
                    console.error('Restart error:', error);
                    alert('ì„œë²„ ì¬ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    restartButton.disabled = false;
                    restartButton.textContent = 'ì„œë²„ ì¬ì‹œì‘';
                }
            };

            // --- Check Admin Status ---
            const checkAdminStatus = async () => {
                try {
                    const response = await fetch('/api/auth/status');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.is_admin) {
                            document.getElementById('restart-server-button').style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error('Admin status check error:', error);
                }
            };

            // --- Logout Function ---
            const handleLogout = async () => {
                try {
                    const response = await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.ok) {
                        window.location.href = '/login';
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    window.location.href = '/login';
                }
            };

            // --- Event Listeners ---
            chatForm.addEventListener('submit', handleFormSubmit);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('restart-server-button').addEventListener('click', handleRestartServer);
            document.getElementById('restart-project-server-button').addEventListener('click', handleRestartProjectServer);
            document.getElementById('deselect-project-button').addEventListener('click', deselectProject);
            document.getElementById('new-chat-button').addEventListener('click', startNewChat);
            document.getElementById('history-button').addEventListener('click', showHistory);
            document.getElementById('history-close').addEventListener('click', closeHistoryModal);
            
            // --- Initial Load ---
            checkAdminStatus();
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.getElementById('history-modal').addEventListener('click', (e) => {
                if (e.target.id === 'history-modal') {
                    closeHistoryModal();
                }
            });

            // --- Initial Load ---
            fetchProjects();
            // ì´ˆê¸° ë¡œë“œ ì‹œ BASE_DIR íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° (í”„ë¡œì íŠ¸ ì„ íƒ ì•ˆ í•¨)
            fetchHistory(null);
        });
    </script>
</body>
</html>
